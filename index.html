<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolatrice dei Dadi GdR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="styles.css">
</head>

<body style="background-color: #c7a95c;">
    <div class="container m-md-5">
        <div class="calculator p-3 rounded shadow position-relative" style="background-color: #edede2;">
            <div class="alert alert-success position-fixed top-50 start-50 translate-middle text-center d-none"
                id="resultBanner" onclick="this.classList.add('d-none');">
            </div>
            <div class="row">
                <div class="col-9 p-0">
                    <input class="w-100 display border border-none bg-dark text-white p-3 rounded" id="display">
                </div>
                <div class="col-3 p-0">
                    <button class="btn bg-dark  text-white  w-100 h-100" onclick="rollDice()">
                        <h2 class="m-1"><svg width="30px" viewBox="0 -2.5 40 40" version="1.1"
                                xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">

                                <title>craps</title>
                                <desc>Created with Sketch.</desc>
                                <g id="icons" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                    <g id="ui-gambling-website-lined-icnos-casinoshunter"
                                        transform="translate(-990.000000, -542.000000)" fill="#FFFFFF"
                                        fill-rule="nonzero">
                                        <g id="square-filled" transform="translate(50.000000, 120.000000)">
                                            <path
                                                d="M961.998802,422.100461 L977.827723,426.337674 C979.390699,426.756064 980.318239,428.361044 979.899441,429.922496 L975.658094,445.735988 C975.239296,447.297441 973.63275,448.224076 972.069748,447.805679 L968.116396,446.746851 C967.901472,447.446596 967.431916,448.046113 966.780741,448.421703 L952.588919,456.607368 C951.187592,457.415636 949.395723,456.935974 948.586667,455.536014 L940.393015,441.358025 C939.583959,439.958065 940.064089,438.167942 941.465415,437.359675 L955.657237,429.174009 C956.109763,428.912998 956.61394,428.780409 957.132122,428.781544 L957.172177,428.782981 L958.410481,424.17016 C958.82928,422.608707 960.435825,421.682071 961.998802,422.100461 Z M956.676441,430.631194 L956.606676,430.662871 L956.538675,430.699217 L942.346853,438.884883 C941.825908,439.185357 941.624589,439.826504 941.862064,440.364013 L941.919711,440.477446 L950.113363,454.655434 C950.414131,455.175872 951.055903,455.376995 951.593937,455.139751 L951.70748,455.08216 L965.899303,446.896495 C966.099713,446.780901 966.256655,446.612376 966.357167,446.413556 L966.410598,446.290809 L960.954868,444.82956 C961.183921,445.518697 960.905749,446.296663 960.251644,446.673942 C959.503478,447.105475 958.546803,446.849384 958.114849,446.101947 C957.763267,445.493584 957.867672,444.74722 958.326227,444.255594 L958.429872,444.154288 L956.240853,443.568474 C954.733697,443.165026 953.8174,441.658232 954.129346,440.1512 L954.169093,439.983807 L954.537562,438.60552 C954.041259,438.556856 953.591345,438.274645 953.335218,437.831454 C952.903265,437.084018 953.159605,436.128274 953.907771,435.696742 C954.30391,435.468254 954.76823,435.42905 955.183804,435.567119 L955.337131,435.62718 L956.676441,430.631194 Z M954.910938,447.949923 L954.98006,448.083837 C955.311032,448.807986 955.042541,449.678487 954.338385,450.084636 C953.590219,450.516168 952.633543,450.260078 952.20159,449.512641 C951.769636,448.765205 952.025976,447.809462 952.774142,447.377929 C953.522308,446.946396 954.478984,447.202487 954.910938,447.949923 Z M966.847,446.202 L967.783,446.453 L967.783,446.452 L966.847,446.202 Z M952.521122,443.814677 L952.590244,443.948591 C952.921216,444.67274 952.652726,445.543241 951.94857,445.949389 C951.200404,446.380922 950.243728,446.124831 949.811774,445.377395 C949.379821,444.629958 949.636161,443.674215 950.384327,443.242682 C951.132493,442.81115 952.089169,443.06724 952.521122,443.814677 Z M960.152814,424.505049 L960.11329,424.625981 L955.871943,440.439472 C955.716254,441.019945 956.027701,441.61552 956.576069,441.82784 L956.697119,441.867326 L972.52604,446.104538 C973.107078,446.260075 973.703234,445.948931 973.915761,445.401098 L973.955286,445.280166 L978.196632,429.466675 C978.352321,428.886203 978.040874,428.290628 977.492506,428.078308 L977.371457,428.038822 L961.542536,423.80161 C960.961497,423.646073 960.365341,423.957216 960.152814,424.505049 Z M959.193,444.15 L959.19,444.152 L960.275,444.443 L960.273,444.44 L959.193,444.15 Z M950.131307,439.67943 L950.200429,439.813344 C950.531401,440.537493 950.26291,441.407994 949.558754,441.814143 C948.810589,442.245675 947.853913,441.989585 947.421959,441.242148 C946.990005,440.494712 947.246346,439.538968 947.994512,439.107436 C948.742677,438.675903 949.699353,438.931994 950.131307,439.67943 Z M969.74803,437.872203 C970.5825,438.095581 971.077712,438.952477 970.854116,439.786134 C970.630521,440.619791 969.772788,441.11452 968.938318,440.891142 C968.103847,440.667765 967.608636,439.810869 967.832231,438.977212 C968.055827,438.143554 968.913559,437.648825 969.74803,437.872203 Z M963.152646,436.106698 C963.987116,436.330076 964.482328,437.186972 964.258733,438.020629 C964.035137,438.854286 963.177405,439.349015 962.342934,439.125637 C961.508464,438.90226 961.013252,438.045364 961.236848,437.211706 C961.460443,436.378049 962.318175,435.88332 963.152646,436.106698 Z M971.411595,430.92679 C972.246065,431.150168 972.741277,432.007064 972.517682,432.840721 C972.294086,433.674378 971.436354,434.169107 970.601883,433.945729 C969.767413,433.722351 969.272201,432.865455 969.495797,432.031798 C969.719392,431.198141 970.577125,430.703412 971.411595,430.92679 Z M964.816211,429.161285 C965.650682,429.384663 966.145894,430.241559 965.922298,431.075216 C965.698702,431.908873 964.84097,432.403602 964.0065,432.180224 C963.172029,431.956846 962.676817,431.09995 962.900413,430.266293 C963.124009,429.432636 963.981741,428.937907 964.816211,429.161285 Z"
                                                id="craps">

                                            </path>
                                        </g>
                                    </g>
                                </g>
                            </svg></h2>
                    </button>
                </div>
            </div>
            <div class="buttons row justify-content-center">
                <!-- Dice buttons -->
                <div class="row g-2">
                    <button class="btn btn-info col-4" onclick="appendToDisplay('d4', true)">
                        <h2 class="m-1">d4</h2>
                    </button>
                    <button class="btn btn-primary col-4" onclick="appendToDisplay('d6', true)">
                        <h2 class="m-1">d6</h2>
                    </button>
                    <button class="btn btn-info col-4" onclick="appendToDisplay('d8', true)">
                        <h2 class="m-1">d8</h2>
                    </button>
                    <button class="btn btn-primary col-4" onclick="appendToDisplay('d10', true)">
                        <h2 class="m-1">d10</h2>
                    </button>
                    <button class="btn btn-info col-4" onclick="appendToDisplay('d12', true)">
                        <h2 class="m-1">d12</h2>
                    </button>
                    <button class="btn btn-primary col-4" onclick="appendToDisplay('d100', true)">
                        <h2 class="m-1">d100</h2>
                    </button>
                    <button class="btn btn-primary col-12" onclick="appendToDisplay('d20', true)">
                        <h1 class="m-1">d20</h1>
                    </button>
                </div>
                <!-- Numeric buttons -->
                <div class="row my-3 ">
                    <button class="btn btn-secondary border col-4" onclick="appendToDisplay('1', false)">1</button>
                    <button class="btn btn-secondary border col-4" onclick="appendToDisplay('2', false)">2</button>
                    <button class="btn btn-secondary border col-4" onclick="appendToDisplay('4', false)">4</button>
                    <button class="btn btn-secondary border col-4" onclick="appendToDisplay('3', false)">3</button>
                    <button class="btn btn-secondary border col-4" onclick="appendToDisplay('5', false)">5</button>
                    <button class="btn btn-secondary border col-4" onclick="appendToDisplay('6', false)">6</button>
                    <button class="btn btn-secondary border col-4" onclick="appendToDisplay('7', false)">7</button>
                    <button class="btn btn-secondary border col-4" onclick="appendToDisplay('8', false)">8</button>
                    <button class="btn btn-secondary border col-4" onclick="appendToDisplay('9', false)">9</button>
                    <button class="btn btn-secondary border col-8" onclick="appendToDisplay('0', false)">0</button>
                    <button class="btn btn-danger border col-4" onclick="saveFormula()">❤</button>
                </div>
                <!-- Operation buttons -->
                <button class="btn btn-danger col-4" onclick="appendToDisplay('s', false)">Svantaggio</button>
                <button class="btn btn-success col-4" onclick="appendToDisplay('v', false)">Vantaggio</button>
                <button class="btn btn-danger col-4" onclick="clearDisplay()">❌</button>
                <button class="btn btn-warning col-4" onclick="appendToDisplay('+', false)">➕</button>
                <button class="btn btn-warning col-4" onclick="appendToDisplay('-', false)">➖</button>
                <button class="btn btn-info col-4" onclick="backspaceDisplay()">◀</button>
                <button class="btn btn-success btn-lg col-12 mt-2" onclick="rollDice()">
                    <h1 class="m-1">Roll</h1>
                </button>
            </div>
        </div>
        <!-- Saved Formulas -->
        <div class="saved-formulas mt-4">
            <h5 class="text-center">Formule Preferite</h5>
            <ul class="list-group" id="savedFormulas"></ul>

        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script>
        let lastButtonWasDice = false;
        

        document.addEventListener('DOMContentLoaded', loadFormulas);
        document.addEventListener('keydown', event=>{
            if(event.key==="Enter") {
                event.preventDefault();
                rollDice()
            }
        });

        function appendToDisplay(value, isDice) {
            const display = document.getElementById('display');
            if (isDice && lastButtonWasDice && display.value.length > 0) display.value += '+';
            else if(lastButtonWasDice &&!isNaN(parseInt(value)))  display.value += '+';
            // else if(!lastButtonWasDice && isDice&& display.value.length != 0)  display.value += '+';
            display.value += value;
            lastButtonWasDice = isDice;
        }

        function clearDisplay() {
            document.getElementById('display').value = '';
            lastButtonWasDice = false;
        }

        function backspaceDisplay() {
            const display = document.getElementById('display');
            display.value = display.value.slice(0, -1);
        }

        function rollDice() {
            const display = document.getElementById('display').value.trim();
            let total = 0;
            let detailedResult = '';
            if (!display) {
                return
            }
            // Controllo se il display contiene solo "s" o "v"
            else if (display === 's' || display === 'v') {
                const roll1 = Math.floor(Math.random() * 20) + 1;
                const roll2 = Math.floor(Math.random() * 20) + 1;
                total = display === 'v' ? Math.max(roll1, roll2) : Math.min(roll1, roll2);
                detailedResult = `(${roll1}, ${roll2}) => ${total}[d20]`;
            } else {
                const dicePattern = /(\d*)d(\d+)([vs])?/g;
                let match;
                let modifiedDisplay = display;

                while ((match = dicePattern.exec(display)) !== null) {
                    const rolls = match[1] ? parseInt(match[1]) : 1;
                    const sides = parseInt(match[2]);
                    const modifier = match[3];
                    let rollResults = [];

                    for (let i = 0; i < rolls; i++) {
                        let roll1 = Math.floor(Math.random() * sides) + 1;
                        let roll2 = Math.floor(Math.random() * sides) + 1;
                        let finalRoll = roll1;
                        if (modifier === 'v') {
                            finalRoll = Math.max(roll1, roll2);
                            detailedResult += `(${roll1}, ${roll2}) => ${finalRoll}[d${sides}]`;
                        } else if (modifier === 's') {
                            finalRoll = Math.min(roll1, roll2);
                            detailedResult += `(${roll1}, ${roll2}) => ${finalRoll}[d${sides}]`;
                        } else {
                            detailedResult += `${finalRoll}[d${sides}]`;
                        }

                        rollResults.push(finalRoll);

                        if (i < rolls - 1) {
                            detailedResult += ' + ';
                        }
                    }
                    detailedResult += '<br>';
                    const rollTotal = rollResults.reduce((sum, roll) => sum + roll, 0);
                    modifiedDisplay = modifiedDisplay.replace(match[0], rollTotal);
                }

                try {
                    total = eval(modifiedDisplay);
                } catch (error) {
                    alert('Errore nella formula inserita.');
                    return;
                }
            }

            const resultBanner = document.getElementById('resultBanner');
            resultBanner.innerHTML = `<h1>Risultato: ${total}</h1><p>${detailedResult}</p>`;
            resultBanner.classList.remove('d-none');
        }

        function saveFormula() {
            const display = document.getElementById('display').value;
            let name = prompt("Inserisci un nome per la formula:");
            if (display && name) {
                name += ": " + display;
                const savedFormulas = document.getElementById('savedFormulas');
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item d-flex justify-content-between align-items-center';

                const formulaButton = document.createElement('button');
                formulaButton.className = 'btn btn-success';
                formulaButton.dataset.id = display;
                formulaButton.textContent = name;

                formulaButton.addEventListener('click', function () {
                    document.getElementById('display').value = this.dataset.id;
                    rollDice();
                    lastButtonWasDice = true;
                });

                const editButton = document.createElement('button');
                editButton.className = 'btn btn-warning btn-sm';
                editButton.innerHTML = '✏️';
                editButton.addEventListener('click', function () {
                    showEditModal(display, name, listItem);
                });

                const deleteButton = document.createElement('button');
                deleteButton.className = 'btn btn-danger btn-sm';
                deleteButton.innerHTML = '🗑️';
                deleteButton.addEventListener('click', function () {
                    savedFormulas.removeChild(listItem);
                    removeFormulaFromLocalStorage(display);
                });

                listItem.appendChild(formulaButton);
                listItem.appendChild(editButton);
                listItem.appendChild(deleteButton);
                savedFormulas.appendChild(listItem);
                saveFormulaToLocalStorage({ id: display, name });
            } else {
                alert("Non è possibile salvare una formula vuota o senza nome.");
            }
        }


        function saveFormulaToLocalStorage(formula) {
            let formulas = JSON.parse(localStorage.getItem('formulas')) || [];
            formulas.push(formula);
            localStorage.setItem('formulas', JSON.stringify(formulas));
        }

        function removeFormulaFromLocalStorage(id) {
            let formulas = JSON.parse(localStorage.getItem('formulas')) || [];
            formulas = formulas.filter(f => f.id !== id);
            localStorage.setItem('formulas', JSON.stringify(formulas));
        }

        function loadFormulas() {
            const savedFormulas = JSON.parse(localStorage.getItem('formulas')) || [];
            const savedFormulasElement = document.getElementById('savedFormulas');
            savedFormulas.forEach(formula => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item d-flex justify-content-between align-items-center';

                const formulaButton = document.createElement('button');
                formulaButton.className = 'btn btn-success';
                formulaButton.dataset.id = formula.id;
                formulaButton.textContent = formula.name;

                formulaButton.addEventListener('click', function () {
                    document.getElementById('display').value = this.dataset.id;
                    rollDice();
                    lastButtonWasDice = true
                });

                const editButton = document.createElement('button');
                editButton.className = 'btn btn-warning btn-sm';
                editButton.innerHTML = '✏️';
                editButton.addEventListener('click', function () {
                    showEditModal(formula.id, formula.name, listItem);
                });

                const deleteButton = document.createElement('button');
                deleteButton.className = 'btn btn-danger btn-sm';
                deleteButton.innerHTML = '🗑️';
                deleteButton.addEventListener('click', function () {
                    savedFormulasElement.removeChild(listItem);
                    removeFormulaFromLocalStorage(formula.id);
                });

                listItem.appendChild(formulaButton);
                listItem.appendChild(editButton);
                listItem.appendChild(deleteButton);
                savedFormulasElement.appendChild(listItem);
            });
        }
    </script>
    <div class="modal" id="editModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modifica Formula</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control" id="editInput" placeholder="Nuovo nome">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="confirmEdit()">Ok</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentEditFormula = null;
        let currentListItem = null;

        function showEditModal(id, name, listItem) {
            currentEditFormula = { id, name };
            currentListItem = listItem;
            document.getElementById('editInput').value = name;
            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
        }

        function confirmEdit() {
            const newName = document.getElementById('editInput').value;
            if (newName) {
                currentListItem.querySelector('.btn-success').textContent = newName;

                removeFormulaFromLocalStorage(currentEditFormula.id);
                saveFormulaToLocalStorage({ id: currentEditFormula.id, name: newName });
            }
        }
    </script>
</body>

</html>