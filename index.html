<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolatrice dei Dadi GdR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="styles.css">
</head>

<body style="background-color: #c7a95c;">
    <div class="container m-md-5">
        <div class="calculator p-3 rounded shadow position-relative" style="background-color: #edede2;" >
            <div class="alert alert-success position-fixed top-50 start-50 translate-middle text-center d-none"
                id="resultBanner" onclick="this.classList.add('d-none');"></div>
            <input class="w-100 display bg-dark text-white p-3 mb-3 rounded" id="display">
            <div class="buttons row justify-content-center">
                <!-- Dice buttons -->
                <div class="row g-2">
                    <button class="btn btn-info col-4" onclick="appendToDisplay('d4', true)"><h2 class="m-1">d4</h2></button>
                    <button class="btn btn-primary col-4" onclick="appendToDisplay('d6', true)"><h2 class="m-1">d6</h2></button>
                    <button class="btn btn-info col-4" onclick="appendToDisplay('d8', true)"><h2 class="m-1">d8</h2></button>
                    <button class="btn btn-primary col-4" onclick="appendToDisplay('d10', true)"><h2 class="m-1">d10</h2></button>
                    <button class="btn btn-info col-4" onclick="appendToDisplay('d12', true)"><h2 class="m-1">d12</h2></button>
                    <button class="btn btn-primary col-4" onclick="appendToDisplay('d100', true)"><h2 class="m-1">d100</h2></button>
                    <button class="btn btn-primary col-12" onclick="appendToDisplay('d20', true)">
                        <h1 class="m-1">d20</h1>
                    </button>
                </div>
                <!-- Numeric buttons -->
                 <div class="row my-3 ">
                    <button class="btn btn-secondary border col-4" onclick="appendToDisplay('1', false)">1</button>
                    <button class="btn btn-secondary border col-4" onclick="appendToDisplay('2', false)">2</button>
                    <button class="btn btn-secondary border col-4" onclick="appendToDisplay('4', false)">4</button>
                    <button class="btn btn-secondary border col-4" onclick="appendToDisplay('3', false)">3</button>
                    <button class="btn btn-secondary border col-4" onclick="appendToDisplay('5', false)">5</button>
                    <button class="btn btn-secondary border col-4" onclick="appendToDisplay('6', false)">6</button>
                    <button class="btn btn-secondary border col-4" onclick="appendToDisplay('7', false)">7</button>
                    <button class="btn btn-secondary border col-4" onclick="appendToDisplay('8', false)">8</button>
                    <button class="btn btn-secondary border col-4" onclick="appendToDisplay('9', false)">9</button>
                    <button class="btn btn-secondary border col-8" onclick="appendToDisplay('0', false)">0</button>
                    <button class="btn btn-danger border col-4" onclick="saveFormula()">‚ù§</button>
                </div>
                <!-- Operation buttons -->
                <button class="btn btn-danger col-4" onclick="appendToDisplay('s', false)">Svantaggio</button>
                <button class="btn btn-success col-4" onclick="appendToDisplay('v', false)">Vantaggio</button>
                <button class="btn btn-danger col-4" onclick="clearDisplay()">‚ùå</button>
                <button class="btn btn-warning col-4" onclick="appendToDisplay('+', false)">‚ûï</button>
                <button class="btn btn-warning col-4" onclick="appendToDisplay('-', false)">‚ûñ</button>
                <button class="btn btn-info col-4" onclick="backspaceDisplay()">‚óÄ</button>
                <button class="btn btn-success btn-lg col-12 mt-2" onclick="rollDice()">
                    <h1 class="m-1">Roll</h1>
                </button>
            </div>
        </div>
        <!-- Saved Formulas -->
        <div class="saved-formulas mt-4">
            <h5 class="text-center">Formule Preferite</h5>
            <ul class="list-group" id="savedFormulas"></ul>

        </div>
    </div>
    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script>
        let lastButtonWasDice = false;

        document.addEventListener('DOMContentLoaded', loadFormulas);

        function appendToDisplay(value, isDice) {
            const display = document.getElementById('display');
            if (!isDice && lastButtonWasDice && display.value != 0 && !isNaN(parseInt(value))) {
                display.value += '+';
            }
            display.value += value;
            lastButtonWasDice = isDice;
        }

        function clearDisplay() {
            document.getElementById('display').value = '';
            lastButtonWasDice = false;
        }

        function backspaceDisplay() {
            const display = document.getElementById('display');
            display.value = display.value.slice(0, -1);
        }

        function rollDice() {
            const display = document.getElementById('display').value;
            const dicePattern = /(\d*)d(\d+)([vs])?/g;
            let match;
            let total = 0;
            let modifiedDisplay = display;
            let detailedResult = '';

            while ((match = dicePattern.exec(display)) !== null) {
                const rolls = match[1] ? parseInt(match[1]) : 1;
                const sides = parseInt(match[2]);
                const modifier = match[3];
                let rollResults = [];

                for (let i = 0; i < rolls; i++) {
                    let roll1 = Math.floor(Math.random() * sides) + 1;
                    let roll2 = Math.floor(Math.random() * sides) + 1;
                    let finalRoll = roll1;
                    if (modifier === 'v') {
                        finalRoll = Math.max(roll1, roll2);
                        detailedResult += `(${roll1}, ${roll2}) => ${finalRoll}[d${sides}]`;
                    } else if (modifier === 's') {
                        finalRoll = Math.min(roll1, roll2);
                        detailedResult += `(${roll1}, ${roll2}) => ${finalRoll}[d${sides}]`;
                    } else {
                        detailedResult += `${finalRoll}[d${sides}]`;
                    }

                    rollResults.push(finalRoll);

                    if (i < rolls - 1) {
                        detailedResult += ' + ';
                    }
                }
                detailedResult += '<br>';
                const rollTotal = rollResults.reduce((sum, roll) => sum + roll, 0);
                modifiedDisplay = modifiedDisplay.replace(match[0], rollTotal);
            }

            try {
                total = eval(modifiedDisplay);
            } catch (error) {
                alert('Errore nella formula inserita.');
                return;
            }

            const resultBanner = document.getElementById('resultBanner');
            resultBanner.innerHTML = `<h1>Risultato: ${total}</h1><p>${detailedResult}</p>`;
            resultBanner.classList.remove('d-none');
        }

        function saveFormula() {
        const display = document.getElementById('display').value;
        let name = prompt("Inserisci un nome per la formula:");
        name+=": "+display; 
        if (display && name) {
            const savedFormulas = document.getElementById('savedFormulas');
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item d-flex justify-content-between align-items-center';

            const formulaButton = document.createElement('button');
            formulaButton.className = 'btn btn-success';
            formulaButton.dataset.id = display;
            formulaButton.textContent = name;

            formulaButton.addEventListener('click', function () {
                document.getElementById('display').value = this.dataset.id;
                rollDice();
                lastButtonWasDice = true

            });

            const editButton = document.createElement('button');
            editButton.className = 'btn btn-warning btn-sm';
            editButton.innerHTML = '‚úèÔ∏è';
            editButton.addEventListener('click', function () {
                showEditModal(display, name, listItem);
            });

            const deleteButton = document.createElement('button');
            deleteButton.className = 'btn btn-danger btn-sm';
            deleteButton.innerHTML = 'üóëÔ∏è';
            deleteButton.addEventListener('click', function () {
                savedFormulas.removeChild(listItem);
                removeFormulaFromLocalStorage(display);
            });

            listItem.appendChild(formulaButton);
            listItem.appendChild(editButton);
            listItem.appendChild(deleteButton);
            savedFormulas.appendChild(listItem);
            saveFormulaToLocalStorage({ id: display, name });
        }
    }

    function saveFormulaToLocalStorage(formula) {
        let formulas = JSON.parse(localStorage.getItem('formulas')) || [];
        formulas.push(formula);
        localStorage.setItem('formulas', JSON.stringify(formulas));
    }

    function removeFormulaFromLocalStorage(id) {
        let formulas = JSON.parse(localStorage.getItem('formulas')) || [];
        formulas = formulas.filter(f => f.id !== id);
        localStorage.setItem('formulas', JSON.stringify(formulas));
    }

    function loadFormulas() {
        const savedFormulas = JSON.parse(localStorage.getItem('formulas')) || [];
        const savedFormulasElement = document.getElementById('savedFormulas');
        savedFormulas.forEach(formula => {
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item d-flex justify-content-between align-items-center';

            const formulaButton = document.createElement('button');
            formulaButton.className = 'btn btn-success';
            formulaButton.dataset.id = formula.id;
            formulaButton.textContent = formula.name;

            formulaButton.addEventListener('click', function () {
                document.getElementById('display').value = this.dataset.id;
                rollDice();
                lastButtonWasDice = true
            });

            const editButton = document.createElement('button');
            editButton.className = 'btn btn-warning btn-sm';
            editButton.innerHTML = '‚úèÔ∏è';
            editButton.addEventListener('click', function () {
                showEditModal(formula.id, formula.name, listItem);
            });

            const deleteButton = document.createElement('button');
            deleteButton.className = 'btn btn-danger btn-sm';
            deleteButton.innerHTML = 'üóëÔ∏è';
            deleteButton.addEventListener('click', function () {
                savedFormulasElement.removeChild(listItem);
                removeFormulaFromLocalStorage(formula.id);
            });

            listItem.appendChild(formulaButton);
            listItem.appendChild(editButton);
            listItem.appendChild(deleteButton);
            savedFormulasElement.appendChild(listItem);
        });
    }
    </script>
    <div class="modal" id="editModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modifica Formula</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control" id="editInput" placeholder="Nuovo nome">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="confirmEdit()">Ok</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentEditFormula = null;
        let currentListItem = null;

        function showEditModal(id, name, listItem) {
        currentEditFormula = { id, name };
        currentListItem = listItem;
        document.getElementById('editInput').value = name;
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        editModal.show();
    }

    function confirmEdit() {
        const newName = document.getElementById('editInput').value;
        if (newName) {
            currentListItem.querySelector('.btn-success').textContent = newName;

            removeFormulaFromLocalStorage(currentEditFormula.id);
            saveFormulaToLocalStorage({ id: currentEditFormula.id, name: newName });
        }
    }
    </script>
</body>

</html>